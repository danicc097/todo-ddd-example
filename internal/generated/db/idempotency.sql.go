// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: idempotency.sql

package db

import (
	"context"

	"github.com/google/uuid"
)

const DeleteIdempotencyKey = `-- name: DeleteIdempotencyKey :exec
DELETE FROM idempotency_keys
WHERE id = $1
`

func (q *Queries) DeleteIdempotencyKey(ctx context.Context, db DBTX, id uuid.UUID) error {
	_, err := db.Exec(ctx, DeleteIdempotencyKey, id)
	return err
}

const GetIdempotencyKey = `-- name: GetIdempotencyKey :one
SELECT
  id, response_status, response_headers, response_body, locked_at, created_at
FROM
  idempotency_keys
WHERE
  id = $1
`

func (q *Queries) GetIdempotencyKey(ctx context.Context, db DBTX, id uuid.UUID) (IdempotencyKeys, error) {
	row := db.QueryRow(ctx, GetIdempotencyKey, id)
	var i IdempotencyKeys
	err := row.Scan(
		&i.ID,
		&i.ResponseStatus,
		&i.ResponseHeaders,
		&i.ResponseBody,
		&i.LockedAt,
		&i.CreatedAt,
	)
	return i, err
}

const TryLockIdempotencyKey = `-- name: TryLockIdempotencyKey :execrows
INSERT INTO idempotency_keys(id, response_status, response_headers, response_body, locked_at)
  VALUES ($1, 0, '{}', '', NOW())
ON CONFLICT (id)
  DO UPDATE SET
    locked_at = NOW()
  WHERE
    idempotency_keys.response_status = 0
    AND idempotency_keys.locked_at < NOW() - INTERVAL '1 minute'
`

func (q *Queries) TryLockIdempotencyKey(ctx context.Context, db DBTX, id uuid.UUID) (int64, error) {
	result, err := db.Exec(ctx, TryLockIdempotencyKey, id)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected(), nil
}

const UpdateIdempotencyKey = `-- name: UpdateIdempotencyKey :exec
UPDATE
  idempotency_keys
SET
  response_status = $2,
  response_headers = $3,
  response_body = $4
WHERE
  id = $1
`

type UpdateIdempotencyKeyParams struct {
	ID              uuid.UUID `db:"id" json:"id"`
	ResponseStatus  int32     `db:"response_status" json:"response_status"`
	ResponseHeaders []byte    `db:"response_headers" json:"response_headers"`
	ResponseBody    []byte    `db:"response_body" json:"response_body"`
}

func (q *Queries) UpdateIdempotencyKey(ctx context.Context, db DBTX, arg UpdateIdempotencyKeyParams) error {
	_, err := db.Exec(ctx, UpdateIdempotencyKey,
		arg.ID,
		arg.ResponseStatus,
		arg.ResponseHeaders,
		arg.ResponseBody,
	)
	return err
}
